
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://phchen9.github.io/nusec-docs/setup/cloud-server-setup/">
      
      
        <link rel="prev" href="../in-this-section/">
      
      
        <link rel="next" href="../nusec-py-setup/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.20">
    
    
      
        <title>Cloud server setup - NuSEC Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cloud-server-setup" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="NuSEC Documentation" class="md-header__button md-logo" aria-label="NuSEC Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NuSEC Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cloud server setup
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="NuSEC Documentation" class="md-nav__button md-logo" aria-label="NuSEC Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    NuSEC Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/components/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Components
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/flow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flow
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Setup
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Setup
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../in-this-section/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    In this section
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cloud server setup
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cloud server setup
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-certificate-authority-ca" class="md-nav__link">
    <span class="md-ellipsis">
      Create a certificate authority (CA)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create a certificate authority (CA)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-prerequisite-software" class="md-nav__link">
    <span class="md-ellipsis">
      Install prerequisite software
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-the-steps-in-the-notebook-to-create-a-ca" class="md-nav__link">
    <span class="md-ellipsis">
      Follow the steps in the notebook to create a CA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-client-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a client certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-server-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a server certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-certificate-chain-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create the certificate chain file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-a-http-api-server" class="md-nav__link">
    <span class="md-ellipsis">
      Host a HTTP API server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Host a HTTP API server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-nodejs" class="md-nav__link">
    <span class="md-ellipsis">
      Install Node.js
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mongodb-community-edition" class="md-nav__link">
    <span class="md-ellipsis">
      Install MongoDB Community Edition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install MongoDB Community Edition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-allow-other-host-to-connect-via-a-specific-network-interface" class="md-nav__link">
    <span class="md-ellipsis">
      (Optional) Allow other host to connect via a specific network interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-softhsm" class="md-nav__link">
    <span class="md-ellipsis">
      Setup softHSM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-env-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create .env file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-sign_csrsh-script" class="md-nav__link">
    <span class="md-ellipsis">
      Setup sign_csr.sh script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-directories-for-storing-files" class="md-nav__link">
    <span class="md-ellipsis">
      Create directories for storing files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-python-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Install python packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-http-api-server" class="md-nav__link">
    <span class="md-ellipsis">
      Run the HTTP API server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nusec-py-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NuSEC.py setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devauth-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevAuth setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../freertos-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FreeRTOS setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devauth-mcu-setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DevAuth for target device setup
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/quick-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quick start
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Sequence Diagrams
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Sequence Diagrams
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/prepare-programmer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prepare programmer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/export-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Export Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/import-package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Import Package
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/device-authentication-provisioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Device provisioning authentication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/firmware-provisioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firmware provisioning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence-diagrams/firmware-upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Firmware upgrade
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-certificate-authority-ca" class="md-nav__link">
    <span class="md-ellipsis">
      Create a certificate authority (CA)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create a certificate authority (CA)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-prerequisite-software" class="md-nav__link">
    <span class="md-ellipsis">
      Install prerequisite software
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-the-steps-in-the-notebook-to-create-a-ca" class="md-nav__link">
    <span class="md-ellipsis">
      Follow the steps in the notebook to create a CA
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-client-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a client certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-a-server-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Sign a server certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-certificate-chain-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create the certificate chain file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#host-a-http-api-server" class="md-nav__link">
    <span class="md-ellipsis">
      Host a HTTP API server
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Host a HTTP API server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-nodejs" class="md-nav__link">
    <span class="md-ellipsis">
      Install Node.js
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-mongodb-community-edition" class="md-nav__link">
    <span class="md-ellipsis">
      Install MongoDB Community Edition
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install MongoDB Community Edition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optional-allow-other-host-to-connect-via-a-specific-network-interface" class="md-nav__link">
    <span class="md-ellipsis">
      (Optional) Allow other host to connect via a specific network interface
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-softhsm" class="md-nav__link">
    <span class="md-ellipsis">
      Setup softHSM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-env-file" class="md-nav__link">
    <span class="md-ellipsis">
      Create .env file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-sign_csrsh-script" class="md-nav__link">
    <span class="md-ellipsis">
      Setup sign_csr.sh script
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-directories-for-storing-files" class="md-nav__link">
    <span class="md-ellipsis">
      Create directories for storing files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-the-certificate" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy the certificate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-python-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Install python packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-the-http-api-server" class="md-nav__link">
    <span class="md-ellipsis">
      Run the HTTP API server
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="cloud-server-setup">Cloud server setup</h1>
<p>This article shows you how to setup a cloud server on <strong>Linux</strong>.
The distro used here is Ubuntu server 22.04.</p>
<h2 id="create-a-certificate-authority-ca">Create a certificate authority (CA)</h2>
<p>The CA created here is backed by HSM. <code>softHSM</code> is used for demonstration.
In production environment a real HSM is recommended.<br>
Users can follow the instructions in the interactive notebook to create CA
step by step.</p>
<h3 id="install-prerequisite-software">Install prerequisite software</h3>
<p>If you don't have a real HSM, please install <code>softHSM</code> first.
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>softhsm
sudo<span class="w"> </span>usermod<span class="w"> </span>-aG<span class="w"> </span>softhsm<span class="w"> </span><span class="nv">$USER</span>
</code></pre></div></p>
<p>Reboot the machine for the changes to be applied:
<div class="highlight"><pre><span></span><code>sudo reboot
</code></pre></div></p>
<p>Python’s package manager, pip, is required to install following packages.
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>python3-pip
</code></pre></div></p>
<p>Before starting the installation, creating and activating
a virtual environment is recommended.
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate
</code></pre></div></p>
<p>To open interactive notebook, install Jupyter Notebook:
<div class="highlight"><pre><span></span><code>pip3<span class="w"> </span>install<span class="w"> </span>jupyter
</code></pre></div></p>
<p>Open <code>creating-a-ca.ipynb</code>:
<div class="highlight"><pre><span></span><code>jupyter<span class="w"> </span>notebook<span class="w"> </span>creating-a-ca.ipynb
</code></pre></div></p>
<p>As described at the begining of the notebook, install following packages:
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>opensc<span class="w"> </span>gnutls-bin<span class="w"> </span>libengine-pkcs11-openssl
</code></pre></div></p>
<h3 id="follow-the-steps-in-the-notebook-to-create-a-ca">Follow the steps in the notebook to create a CA</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before executing commands, please make sure the placeholder wrapped with
angle bracket(<code>&lt;&gt;</code>) is replaced with your own value.</p>
</div>
<p>Here is a summary to help you understand what the commands provided in the
notebook do:</p>
<ul>
<li>Initialize softHSM</li>
<li>Generate a private key for root CA on softHSM</li>
<li>Choose a directory to store all certificates and keep track of signed certificates</li>
<li>Prepare a root CA configuration file for OpenSSL</li>
<li>Use the root key to create a root certificate</li>
<li>Generate a private key for intermediate CA on softHSM</li>
<li>Prepare a intermediate CSR configuration file for OpenSSL</li>
<li>Create a intermediate CSR</li>
<li>Prepare a intermediate CA configuration file for OpenSSL</li>
<li>Create a intermediate certificate by signing a intermediate CSR with the root key</li>
<li>Prepare a client certificate configuration file for OpenSSL</li>
<li>(Optional) Create a client certificate by signing a client CSR with the intermediate key</li>
<li>Prepare a server certificate configuration file for OpenSSL</li>
</ul>
<p>Now the intermediate CA is ready to sign a client or server certificate.
The client certificate can be used for client authentication. And the server
certificate enable servers to use HTTPS.</p>
<h3 id="sign-a-client-certificate">Sign a client certificate</h3>
<p>To run <a href="../nusec-py-setup/">NuSEC.py</a>, a client certificate is required.
Follow the steps to create a certificate for the client.</p>
<p>Create a private key.</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>ecparam<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-genkey<span class="w"> </span>-noout<span class="w"> </span>-out<span class="w"> </span>client_key.pem
</code></pre></div>
<p>Generate a CSR using the private key</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>client_key.pem<span class="w"> </span>-out<span class="w"> </span>client.csr
</code></pre></div>
<div class="highlight"><pre><span></span><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:TW
State or Province Name (full name) [Some-State]:Taiwan
Locality Name (eg, city) []:.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Nuvoton
Organizational Unit Name (eg, section) []:Tool
Common Name (e.g. server FQDN or YOUR name) []:NuSEC.py
Email Address []:.
</code></pre></div>
<p>Use the intermediate CA to sign the CSR to create a certificate for client.
<div class="highlight"><pre><span></span><code>openssl ca -batch -config config/sign_client_csrs.ini -engine pkcs11 -keyform engine \
  -extensions client_cert -notext -create_serial \
  -in client.csr -out client_cert.pem
</code></pre></div></p>
<h3 id="sign-a-server-certificate">Sign a server certificate</h3>
<p>Users has to deploy a certificate to the HTTP API server mentioned below.
Follow the steps to create a certificate for the server.</p>
<p>Create a private key.</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>ecparam<span class="w"> </span>-name<span class="w"> </span>prime256v1<span class="w"> </span>-genkey<span class="w"> </span>-noout<span class="w"> </span>-out<span class="w"> </span>key.pem
</code></pre></div>
<p>Generate a CSR using the private key</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-sha256<span class="w"> </span>-key<span class="w"> </span>key.pem<span class="w"> </span>-out<span class="w"> </span>server.csr
</code></pre></div>
<div class="highlight"><pre><span></span><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:TW
State or Province Name (full name) [Some-State]:Taiwan
Locality Name (eg, city) []:.
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Nuvoton
Organizational Unit Name (eg, section) []:Tool
Common Name (e.g. server FQDN or YOUR name) []:Nuvoton Certificate
Email Address []:.
</code></pre></div>
<p>Use the intermediate CA to sign the CSR to create a certificate for server.
<div class="highlight"><pre><span></span><code>openssl ca -batch -config config/sign_server_csrs.ini -engine pkcs11 -keyform engine \
  -extensions server_cert -days 375 -notext -create_serial \
  -in server.csr -out server.crt
</code></pre></div></p>
<p>Combine the certificates
<div class="highlight"><pre><span></span><code>cat server.crt intermediate/certs/intermediate.crt certs/root.crt &gt; combine.crt
</code></pre></div></p>
<h3 id="create-the-certificate-chain-file">Create the certificate chain file</h3>
<p>Concatenate the intermediate and root certificates to create the
CA certificate chain.</p>
<div class="highlight"><pre><span></span><code>cat<span class="w"> </span>intermediate/certs/intermediate.crt<span class="w"> </span>certs/root.crt<span class="w"> </span>&gt;<span class="w"> </span>intermediate/certs/ca-chain.crt
</code></pre></div>
<h2 id="host-a-http-api-server">Host a HTTP API server</h2>
<p>NuSEC system provides a HTTP API server built with Node.js and Express.
The server exposes endpoints that a client (e.g. NuSEC.py &amp; NuLink) use to
access the resources.</p>
<h3 id="install-nodejs">Install Node.js</h3>
<p>The first thing to do is to install Node.js using node version manager (nvm).
Please follow the latest directions <a href="https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions">here</a>. Or, execute the following
commands which work as of the time of writing.
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-o-<span class="w"> </span>https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>bash
<span class="nb">source</span><span class="w"> </span>~/.bashrc
nvm<span class="w"> </span>install<span class="w"> </span><span class="m">20</span>
</code></pre></div></p>
<p>Navigate to the project directory and install the dependencies:
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>nusec-server
nvm<span class="w"> </span>install
</code></pre></div></p>
<h3 id="install-mongodb-community-edition">Install MongoDB Community Edition</h3>
<p>Please follow the latest directions <a href="https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu">here</a>. Or, execute the following
commands which work as of the time of writing.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>gnupg<span class="w"> </span>curl
curl<span class="w"> </span>-fsSL<span class="w"> </span>https://www.mongodb.org/static/pgp/server-7.0.asc<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>gpg<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/mongodb-server-7.0.gpg<span class="w"> </span>--dearmor
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/mongodb-org-7.0.list
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>mongodb-org
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>mongod
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>mongod
</code></pre></div>
<h4 id="optional-allow-other-host-to-connect-via-a-specific-network-interface">(Optional) Allow other host to connect via a specific network interface</h4>
<p>The user might want to connect to MongoDB instance from other host.
If so, please edit the configuration file of MongoDB.
Add IP addresses that MongoDB instance should listen for client connection.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>nano<span class="w"> </span>/etc/mongod.conf
</code></pre></div>
<div class="highlight"><pre><span></span><code># network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1, &lt;new-ip-addr&gt;
</code></pre></div>
<p>Restart the instance for the changes to take effect.</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>systemctl<span class="w"> </span>restart<span class="w"> </span>mongod
</code></pre></div>
<h3 id="setup-softhsm">Setup softHSM</h3>
<p>Please make sure softHSM has been installed on your machine. If not,
follow the instruction <a href="#install-prerequisite-software">here</a>.</p>
<p>Follow the directions below to initialize two tokens.
Keypairs for secure boot will be stored on these tokens.</p>
<div class="highlight"><pre><span></span><code>softhsm2-util --init-token --free --label cmprogrammer --so-pin &lt;so-pin-for-cmprogrammer-token&gt; --pin &lt;pin-for-cmprogrammer-token&gt;
softhsm2-util --init-token --free --label mcu --so-pin &lt;so-pin-for-mcu-token&gt; --pin &lt;pin-for-mcu-token&gt;
</code></pre></div>
<h3 id="create-env-file">Create <code>.env</code> file</h3>
<p>Navigate to the root of project directory and create a new file named <code>.env</code>.
Please add following environment variables to it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please make sure the placeholder wrapped with
angle bracket(<code>&lt;&gt;</code>) is replaced with your own value.</p>
</div>
<div class="highlight"><pre><span></span><code>DATABASE_URL = mongodb://127.0.0.1:27017
PROG_SOPIN = &lt;so-pin-for-cmprogrammer-token&gt;
PROG_PIN = &lt;pin-for-cmprogrammer-token&gt;
MCU_SOPIN = &lt;so-pin-for-mcu-token&gt;
MCU_PIN = &lt;pin-for-mcu-token&gt;
</code></pre></div>
<h3 id="setup-sign_csrsh-script">Setup <code>sign_csr.sh</code> script</h3>
<p>Please navigate to the root of project directory and edit <code>sign_csr.sh</code>.
Assign to <code>INI</code> variable with the path of <code>sign_client_csrs.ini</code>
(client certificate configuration file).
It should be located in the CA directory created in 
<a href="#follow-the-steps-in-the-notebook-to-create-a-ca">this step</a>.</p>
<div class="highlight"><pre><span></span><code>INI=&lt;path-of-ca-directory&gt;/config/sign_client_csrs.ini
</code></pre></div>
<h3 id="create-directories-for-storing-files">Create directories for storing files</h3>
<p>Files such as firmware or certificates will be stored in the directories
created by this script.
<div class="highlight"><pre><span></span><code>./create_dirs.sh
</code></pre></div></p>
<h3 id="deploy-the-certificate">Deploy the certificate</h3>
<p>In <a href="#sign-a-server-certificate">pervious section</a>, a key, a server certificate
and a CA certificate chain files have been created.
Please make them available to node.js server 
(place these files in the root of project directory):</p>
<ul>
<li><code>ca-chain.crt</code></li>
<li><code>key.pem</code></li>
<li><code>combine.crt</code></li>
<li><code>root.crt</code></li>
<li><code>intermediate.crt</code></li>
</ul>
<h3 id="install-python-packages">Install python packages</h3>
<p>The server will execute python script to perform operations on softHSM.
Therefore following package is required:
<div class="highlight"><pre><span></span><code>pip3 install python-pkcs11
</code></pre></div></p>
<h3 id="run-the-http-api-server">Run the HTTP API server</h3>
<p>Now the server is ready. Navigate to the root of project directory and
run the server with following command:</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>start
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dd8806f2.min.js"></script>
      
    
  </body>
</html>